<mat-card style="max-width: 1100px; margin: 16px auto; padding: 12px;">
    <mat-card-title>Books</mat-card-title>

    <!-- Loading -->
    <mat-progress-bar *ngIf="loading" mode="indeterminate" style="margin-top: 10px;"></mat-progress-bar>

    <!-- Error -->
    <div *ngIf="error" style="color:#b00020; margin-top: 10px;">
        {{ error }}
    </div>

    <!-- Filters -->
    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top: 14px;">
        <!-- Search Bar -->
        <mat-form-field appearance="outline" style="min-width: 260px; flex: 1;">
            <mat-label>Search</mat-label>
            <input matInput placeholder="title/author/genre" [(ngModel)]="search" (keyup.enter)="applyFilters()" />
        </mat-form-field>

        <!-- Genre (exact) -->
        <mat-form-field appearance="outline" style="min-width: 180px;">
            <mat-label>Genre (exact)</mat-label>
            <input matInput placeholder="Genre" [(ngModel)]="genre" (keyup.enter)="applyFilters()" />
        </mat-form-field>

        <!-- Year From -->
        <mat-form-field appearance="outline" style="width: 140px;">
            <mat-label>Year From</mat-label>
            <input matInput type="number" [(ngModel)]="yearFrom" (keyup.enter)="applyFilters()" />
        </mat-form-field>

        <!-- Year To -->
        <mat-form-field appearance="outline" style="width: 140px;">
            <mat-label>Year To</mat-label>
            <input matInput type="number" [(ngModel)]="yearTo" (keyup.enter)="applyFilters()" />
        </mat-form-field>

        <!-- Min Price -->
        <mat-form-field appearance="outline" style="width: 140px;">
            <mat-label>Min Price</mat-label>
            <input matInput type="number" [(ngModel)]="minPrice" (keyup.enter)="applyFilters()" />
        </mat-form-field>

        <!-- Max Price -->
        <mat-form-field appearance="outline" style="width: 140px;">
            <mat-label>Max Price</mat-label>
            <input matInput type="number" [(ngModel)]="maxPrice" (keyup.enter)="applyFilters()" />
        </mat-form-field>

        <!-- Page Size -->
        <mat-form-field appearance="outline" style="width: 140px;">
            <mat-label>Page Size</mat-label>
            <mat-select [(ngModel)]="pageSize" (selectionChange)="applyFilters()">
                <mat-option [value]="5">5</mat-option>
                <mat-option [value]="10">10</mat-option>
                <mat-option [value]="20">20</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Availability -->
        <mat-form-field appearance="outline" style="width: 180px;">
            <mat-label>Availability</mat-label>
            <mat-select [(ngModel)]="availability" (selectionChange)="applyFilters()">
                <mat-option [value]="null">All</mat-option>
                <mat-option [value]="true">Available</mat-option>
                <mat-option [value]="false">Unavailable</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Deleted Status (ADMIN ONLY) -->
        <mat-form-field *ngIf="isAdmin" appearance="outline" style="width: 180px;">
            <mat-label>Deleted Status</mat-label>
            <mat-select [(ngModel)]="isDeleted" (selectionChange)="applyFilters()">
                <mat-option [value]="null">All</mat-option>
                <mat-option [value]="false">Active</mat-option>
                <mat-option [value]="true">Inactive</mat-option>
            </mat-select>
        </mat-form-field>

        <div style="display:flex; gap:10px; align-items:center;">
            <!-- Search Button -->
            <button mat-raised-button color="primary" (click)="applyFilters()">
                <mat-icon>search</mat-icon>
                Search
            </button>

            <!-- Clear Button -->
            <button mat-stroked-button (click)="clearFilters()">
                <mat-icon>clear</mat-icon>
                Clear
            </button>
        </div>
    </div>

    <!-- Table -->
    <div style="margin-top: 14px; overflow:auto;" *ngIf="paged">
        <table mat-table [dataSource]="paged.items" class="mat-elevation-z1" style="width:100%;">

            <!-- Title -->
            <ng-container matColumnDef="title">
                <th mat-header-cell *matHeaderCellDef>Title</th>
                <td mat-cell *matCellDef="let b">{{ b.title }}</td>
            </ng-container>

            <!-- Author -->
            <ng-container matColumnDef="author">
                <th mat-header-cell *matHeaderCellDef>Author</th>
                <td mat-cell *matCellDef="let b">{{ b.author }}</td>
            </ng-container>

            <!-- Genre -->
            <ng-container matColumnDef="genre">
                <th mat-header-cell *matHeaderCellDef>Genre</th>
                <td mat-cell *matCellDef="let b">{{ b.genre }}</td>
            </ng-container>

            <!-- Year -->
            <ng-container matColumnDef="year">
                <th mat-header-cell *matHeaderCellDef>Year</th>
                <td mat-cell *matCellDef="let b">{{ b.publicationYear }}</td>
            </ng-container>

            <!-- ISBN -->
            <ng-container matColumnDef="isbn">
                <th mat-header-cell *matHeaderCellDef>ISBN</th>
                <td mat-cell *matCellDef="let b">{{ b.isbn }}</td>
            </ng-container>

            <!-- Price -->
            <ng-container matColumnDef="price">
                <th mat-header-cell *matHeaderCellDef>Price</th>
                <td mat-cell *matCellDef="let b">{{ b.price | currency:'GBP' }}</td>
            </ng-container>

            <!-- Availability -->
            <ng-container matColumnDef="availability">
                <th mat-header-cell *matHeaderCellDef>Availability</th>
                <td mat-cell *matCellDef="let b">
                    <span [style.color]="b.isAvailable ? '#2e7d32' : '#b00020'">
                        {{ b.isAvailable ? 'Available' : 'Unavailable' }}
                    </span>

                    <span *ngIf="!b.isAvailable && b.borrowedByUsername" style="margin-left:6px; opacity:.8;">
                        ({{ b.borrowedByUsername }})
                    </span>
                </td>
            </ng-container>

            <!-- Delete Status (ADMIN ONLY) -->
            <ng-container matColumnDef="deleteStatus" *ngIf="isAdmin">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let b">
                    <span [style.color]="b.isDeleted ? '#b00020' : '#2e7d32'">
                        {{ b.isDeleted ? 'Inactive' : 'Active' }}
                    </span>
                </td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef style="width:240px;">Actions</th>

                <td mat-cell *matCellDef="let b">
                    <div class="action-row">
                        <!-- Details -->
                        <button mat-icon-button matTooltip="Details" (click)="goToDetails(b)">
                            <mat-icon>info</mat-icon>
                        </button>

                        <ng-container *ngIf="auth.isAdmin()">
                            <!-- Borrow / Return toggle -->
                            <button *ngIf="b.isAvailable && !b.isDeleted" mat-icon-button matTooltip="Borrow"
                                matTooltipPosition="above" (click)="borrow(b)">
                                <mat-icon>shopping_cart</mat-icon>
                            </button>

                            <button *ngIf="!b.isAvailable && !b.isDeleted" mat-icon-button color="warn"
                                matTooltip="Return" matTooltipPosition="above" (click)="returnBook(b)">
                                <mat-icon>assignment_return</mat-icon>
                            </button>

                            <!-- Edit -->
                            <button *ngIf="!b.isDeleted && b.isAvailable" mat-icon-button matTooltip="Edit"
                                (click)="goToEdit(b)" [disabled]="b.isDeleted">
                                <mat-icon>edit</mat-icon>
                            </button>

                            <!-- Delete -->
                            <button *ngIf="!b.isDeleted && b.isAvailable" mat-icon-button color="warn"
                                matTooltip="Delete" matTooltipPosition="above" (click)="delete(b.id)">
                                <mat-icon>delete</mat-icon>
                            </button>

                            <!-- Restore -->
                            <button *ngIf="b.isDeleted" mat-icon-button color="primary" matTooltip="Restore"
                                matTooltipPosition="above" (click)="restore(b)">
                                <mat-icon>restore</mat-icon>
                            </button>

                        </ng-container>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="paged" style="margin-top: 14px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <button mat-stroked-button (click)="prev()" [disabled]="pageNumber <= 1">
            <mat-icon>chevron_left</mat-icon>
            Prev
        </button>

        <span style="opacity:.85;">
            Page <b>{{ paged.pageNumber }}</b> of <b>{{ paged.totalPages }}</b>
            ({{ paged.totalCount }} total)
        </span>

        <button mat-stroked-button (click)="next()" [disabled]="pageNumber >= paged.totalPages">
            Next
            <mat-icon>chevron_right</mat-icon>
        </button>
    </div>
</mat-card>